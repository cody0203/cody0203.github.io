<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">

    <title>QLSV - Danh sách học viên</title>
</head>

<body>
    <div class="container">
        <h1 class="text-center m-4">Danh sách học viên</h1>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Họ tên</th>
                        <th>Năm sinh</th>
                        <th>Email</th>
                        <th>Số điện thoại</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>
                </tbody>
            </table>
            <div class="spinner text-center">
            </div>
        </div>
    </div>

    <div class="modal fade" id="editStudent" tabindex="-1" role="dialog" aria-labelledby="editStudentLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentLabel">Sửa thông tin</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="studentName">Họ tên</label>
                        <input type="text" class="form-control" id="studentNameEdit">
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-group">
                        <label for="studentBirthYear">Năm sinh</label>
                        <input type="text" class="form-control" id="studentBirthYearEdit">
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-group">
                        <label for="studentEmail">Email</label>
                        <input type="email" class="form-control" id="studentEmailEdit">
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="form-group">
                        <label for="studentPhone">Số điện thoại</label>
                        <input type="text" class="form-control" id="studentPhoneEdit">
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary save-data" onclick="saveStudentInfo()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <script>
        let rawData = []
        let convertedData = undefined;
        let currentId = "";
        function renderContent() {
            $.ajax({
                url: "https://student-rest-api.firebaseapp.com/api/v1/students",
                method: "GET"
            }).done(function (result) {
                rawData = result.students;
                let htmlContent = '';
                convertedData = convertData(rawData)
                students = sortByTime(convertedData)
                for (let i in students) {
                    const s = students[i];

                    htmlContent += `
                    <tr>
                        <td>${s.name || ''}</td>
                        <td>${s.birthYear || ''}</td>
                        <td>${s.email || ''}</td>
                        <td>${s.phone || ''}</td>
                        <td>
                            <a href="javascript:void(0)" class="text-danger delete-text-btn" id=${s.id} onclick="deleteStudent(this)">
                                <i class="fa fa-trash-alt"></i> Xóa
                            </a>
                            <a href="javascript:void(0)" class="text-secondary edit-text-btn ml-3" id=${s.id} onclick="editStudent(this)" data-toggle="modal" data-target="#editStudent">
                                <i class="fa fa-pen-alt"></i> Sửa
                            </a>
                        </td>
                    </tr>
                `
                }

                $('tbody').html(htmlContent);
            });
        }

        function deleteStudent(target) {
            let id = $(target).attr('id');
            if (confirm("Are you sure?")) {
                // Chống bấm liên tục
                let isLoading = true;
                $(target).parent().parent().remove();
                loadingStatus(isLoading)

                $.ajax({
                    url: `https://student-rest-api.firebaseapp.com/api/v1/students/${id}`,
                    method: "DELETE"
                }).done(function (result) {
                    isLoading = false;
                    loadingStatus(isLoading)
                    renderContent()
                })
            }
        }

        function editStudent(target) {
            let id = $(target).attr('id');
            let currentStudent = students.find(student => student['id'] == id)
            $('#studentNameEdit').val(currentStudent['name'])
            $('#studentBirthYearEdit').val(currentStudent['birthYear'])
            $('#studentEmailEdit').val(currentStudent['email'])
            $('#studentPhoneEdit').val(currentStudent['phone'])
            currentId = id;
        }

        function saveStudentInfo() {
            let isLoading = true;
            $('#editStudent').modal('hide')
            loadingStatus(isLoading)

            $.ajax({
                url: `https://student-rest-api.firebaseapp.com/api/v1/students/${currentId}`,
                method: "PUT"
            }).done(function (result) {
                isLoading = false;
                loadingStatus(isLoading)
                renderContent()
            })

        }

        function loadingStatus(status) {
            if (status == true) {
                let spinner = `
                <div class="spinner-grow" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                `;
                $('.spinner').html(spinner);
                $('tbody').html("")
            } else {
                $('.spinner').html("");
            }
        }

        function convertData(source) {
            let arr = [];
            let key = []
            for (let i in source) {
                arr.push(source[i]);
                key.push(i)
            }
            for (let i = 0; i < arr.length; i++) {
                arr[i]['id'] = key[i]
            }
            return arr;
        }

        function sortByTime(students) {
            return students.sort((a, b) => {
                return a['created'] - b['created']
            })
        }

        $(function () {
            renderContent();
        })
    </script>
</body>

</html>